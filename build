#!/bin/sh

# Blacklist filter (BLACKLIST in the config file)
page_filter() {
  for b in $MENU_BLACKLIST; do
    [ "$b" = "$1" ] && return 0
  done
}

site_menu() {
    echo "<ul>"

    # Conditional directory navigation
    [ -z "`echo $1 | grep index.md`" ] && echo "<li><a href=\"index.html\">`dirname $1`</a></li>"
    [ "`dirname $1`" != "." ] && echo "<li><a href=\"../index.html\">..</a></li>"

    FILES=`ls \`dirname $1\` | sed -e 's/\.md$/.html/g'`
    for i in $FILES ; do
        page_filter $i && continue
        NAME=`echo $i | sed -e 's/\..*$//'`
        [ -z "`echo $i | grep '\..*$'`" ] && i="$i/index.html"
        echo "<li><a href=\"$i\">$NAME</a></li>"
    done

    echo "</ul>"
}

site_page() {
  # Header
  cat << _header_
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Will Langstroth">
    <meta name="generator" content="Magnetized needle and a steady hand">
    <title>${TITLE}</title>
_header_

  # Stylesheet
  site_style

  cat << _header_
  </head>
  <body>
    <header>
      <h1>
        <a href="`echo $1 | sed -e 's|[^/]*/|../|g' -e 's|[^/]*\.md$|index.html|g'`">${TITLE}</a> <span>${SUBTITLE}</span>
      </h1>
_header_

  # Menu
  echo "   <nav>"
  site_menu $1
  echo "   </nav>"

  echo "  </header>"

  # Body
  echo "<div id=\"main\">"
  $MDHANDLER $1
  echo "</div>"

  # Footer
  cat << _footer_
  <footer>
    <div class="right">Site generated by <a href="https://github.com/wlangstroth/org">shell script</a></div>
  </footer>
  </body>
</html>
_footer_
}

site_style() {
    if [ -f $WORKING_DIR/css/fonts.css ]; then
        echo '<style>'
        cat $WORKING_DIR/css/fonts.css
        echo '</style>'
    fi

    if [ -f $WORKING_DIR/css/style.css ]; then
        echo '<style>'
        cat $WORKING_DIR/css/style.css
        echo '</style>'
    fi
}

# ------------------------------------------------------------------------------
# Moin routine
# ------------------------------------------------------------------------------

# Load config file
if [ ! -f site.conf ]; then
    echo "Cannot find site.conf in current directory"
    exit 1
fi

. site.conf

WORKING_DIR=$PWD
OUTPUT_DIR="$WORKING_DIR/`basename $INPUT_DIR`.static"
rm -rf $OUTPUT_DIR
mkdir -p $OUTPUT_DIR
cp -rf $INPUT_DIR/* $OUTPUT_DIR
rm -f `find $OUTPUT_DIR -type f -iname '*.md'`

# Parse and generate
cd $INPUT_DIR
FILES=`find . -iname '*.md' | sed -e 's|^\./||'`
for a in $FILES; do
  b="$OUTPUT_DIR/`echo $a | sed -e 's|\.md$|.html|g'`"
  echo "* $a"
  site_page $a > $b;
done

exit 0
